# NixOS 25.05 Wayland Configuration - Improvements Applied

This document summarizes the comprehensive improvements made to your NixOS configuration for proper Wayland support, version synchronization, and adherence to NixOS 25.05 best practices.

## ğŸ¯ Major Changes Applied

### 1. System Version Synchronization

- **Flake Input Changes**: Modified `flake.nix` to use NixOS 25.05 stable channel for system packages
- **Package Channel Separation**: System uses stable channel, user packages can use bleeding edge
- **Home Manager Sync**: Updated to use Home Manager release-25.05 branch
- **Version Sync Module**: Created `modules/core/version-sync.nix` for version management

### 2. Enhanced Wayland Support

- **GNOME 48 "Bengaluru"**: Configured for NixOS 25.05 with enhanced Wayland integration
- **Fixed Session Wrapper**: Resolved gnome-session wrapper "-l" flag error
- **Environment Variables**: Added comprehensive Wayland application compatibility
- **XDG Portals**: Enhanced configuration for screen sharing and desktop integration

### 3. GPU-Specific Optimizations

#### AMD Desktop Configuration

- Early kernel mode setting with `amdgpu` in `initrd.kernelModules`
- Enhanced kernel parameters for Wayland performance
- LACT integration for GPU control
- Proper VDPAU and Vulkan driver configuration

#### Intel Laptop Configuration

- Modern Intel media driver (iHD) with hybrid codec support
- Intel-specific kernel optimizations
- Enhanced VAAPI configuration with fallback support

### 4. Performance Enhancements

- **Triple Buffering**: Added Mutter overlay for smoother animations
- **Audio System**: Confirmed PipeWire configuration for optimal Wayland performance
- **Memory Management**: Optimized kernel parameters and GPU settings

## ğŸ“‹ Configuration Structure

### Modified Files

1. **`flake.nix`**

   - Version synchronization (system stable, packages bleeding edge)
   - Triple buffering overlay for GNOME performance
   - Proper channel management

2. **`hosts/shared/common.nix`**

   - Enhanced Wayland environment variables
   - Fixed gnome-session wrapper
   - XDG portal configuration for screen sharing

3. **`hosts/default/configuration.nix`** (AMD Desktop)

   - Enhanced AMD GPU configuration
   - Wayland-optimized kernel parameters
   - Early kernel mode setting

4. **`hosts/laptop/configuration.nix`** (Intel Laptop)

   - Modern Intel graphics drivers
   - Enhanced codec support
   - Intel-specific optimizations

5. **`modules/desktop/coordinator.nix`**

   - Comprehensive Wayland environment variables
   - Enhanced application compatibility

6. **`modules/desktop/gnome/default.nix`**

   - NixOS 25.05 GNOME configuration
   - Pipewire integration
   - Wayland application support

7. **`modules/core/version-sync.nix`** (New)
   - Version synchronization system
   - System health checks
   - Channel management

## ğŸ› ï¸ New Diagnostic Tools

### 1. GNOME Session Cleanup Script

**Location**: `user-scripts/gnome-session-cleanup.sh`

**Purpose**: Fixes the gnome-session wrapper "-l" flag error

**Usage**:

```bash
./user-scripts/gnome-session-cleanup.sh
```

**Features**:

- Backs up and removes corrupted session files
- Cleans problematic autostart entries
- Verifies Wayland session setup
- Optional GDM restart

### 2. Wayland Diagnostic Script

**Location**: `user-scripts/wayland-diagnostic.sh`

**Purpose**: Comprehensive system diagnosis for Wayland and GPU configuration

**Usage**:

```bash
./user-scripts/wayland-diagnostic.sh
```

**Features**:

- System and GPU information
- Wayland session verification
- Graphics driver status
- Audio system check
- XDG portal verification
- Performance indicators
- Automated recommendations

### 3. System Version Check Commands

Added to system packages:

```bash
nixos-version-check    # Check version synchronization
nixos-wayland-check    # Verify Wayland session setup
```

## ğŸ”§ Essential Configuration Options

### Version Synchronization

```nix
modules.core.versionSync = {
  enable = true;
  systemChannel = "stable";      # Use stable NixOS 25.05 for system
  packageChannel = "bleeding";   # Use bleeding edge for packages
  forceSystemStable = true;      # Force system components to stable
};
```

### Wayland Environment Variables

```nix
environment.sessionVariables = {
  NIXOS_OZONE_WL = "1";        # Chromium/Electron Wayland support
  GDK_BACKEND = "wayland,x11"; # GTK applications prefer Wayland
  MOZ_ENABLE_WAYLAND = "1";    # Firefox Wayland support
  QT_QPA_PLATFORM = "wayland;xcb"; # Qt applications
  WAYLAND_DISPLAY = "wayland-0";
};
```

### GPU-Specific Configurations

#### AMD (Desktop)

```nix
boot.initrd.kernelModules = [ "amdgpu" ];
hardware.graphics.extraPackages = with pkgs; [
  amdvlk                    # AMD Vulkan driver
  libva-vdpau-driver
  libvdpau-va-gl
];
```

#### Intel (Laptop)

```nix
hardware.graphics.extraPackages = with pkgs; [
  intel-media-driver     # Modern driver (iHD)
  intel-vaapi-driver     # Legacy driver (i965)
  vpl-gpu-rt            # Quick Sync Video
  libvdpau-va-gl        # VDPAU support
];
```

## ğŸ¯ Key Benefits

1. **Stable System Base**: NixOS 25.05 stable channel ensures reliable system operation
2. **Latest Packages**: Bleeding edge packages for user applications
3. **Optimal Wayland Support**: Proper GNOME 48 configuration with Wayland by default
4. **GPU Performance**: Hardware-specific optimizations for both AMD and Intel
5. **Session Reliability**: Fixed gnome-session wrapper issues
6. **Enhanced Diagnostics**: Comprehensive troubleshooting tools
7. **Screen Sharing**: Proper XDG portal configuration for video calls
8. **Audio Integration**: PipeWire configured for low-latency Wayland audio

## ğŸš€ Verification Steps

After rebuilding your system:

1. **Check Version Sync**:

   ```bash
   nixos-version-check
   ```

2. **Verify Wayland Session**:

   ```bash
   nixos-wayland-check
   ```

3. **Run Full Diagnostics**:

   ```bash
   ./user-scripts/wayland-diagnostic.sh
   ```

4. **Test GPU Acceleration**:

   ```bash
   vainfo          # Video acceleration
   vulkaninfo      # Vulkan support
   glxinfo         # OpenGL support
   ```

5. **If Session Issues Occur**:
   ```bash
   ./user-scripts/gnome-session-cleanup.sh
   ```

## ğŸ”„ Rebuilding the System

To apply these changes:

```bash
# Update flake inputs
nix flake update

# Rebuild system configuration
sudo nixos-rebuild switch --flake .#default  # For desktop
# or
sudo nixos-rebuild switch --flake .#laptop   # For laptop

# Restart GDM for session changes
sudo systemctl restart gdm
```

## ğŸ“š Documentation References

This configuration follows the guidelines from:

- NixOS 25.05 GNOME Wayland Configuration Guide
- Official NixOS Manual for version 25.05
- GNOME 48 "Bengaluru" release notes
- Hardware-specific GPU optimization guides

## ğŸ› Troubleshooting

### Common Issues and Solutions

1. **gnome-session "-l" flag error**:

   - Run `gnome-session-cleanup.sh`
   - Clear saved session files manually

2. **Application not using Wayland**:

   - Check environment variables with `nixos-wayland-check`
   - Verify XDG portal configuration

3. **GPU acceleration not working**:

   - Run `wayland-diagnostic.sh` for detailed analysis
   - Check driver installation and kernel modules

4. **Screen sharing not working**:
   - Verify XDG portals are running
   - Check GNOME shell extensions compatibility

This configuration provides a robust, modern NixOS 25.05 setup with optimal Wayland support while maintaining system stability through version synchronization.

# Wayland Configuration and Improvements

This document outlines the Wayland configuration and improvements implemented across the NixOS system.

## WiFi and Hardware Resolution

### Issues Resolved:
- **WiFi Hardware Block**: Fixed persistent hardware rfkill issue on Intel AX201
- **WiFi Device Recognition**: Resolved WiFi device not appearing in NetworkManager
- **Hardware Detection**: Identified laptop as Avell (Clevo-based), not ASUS

### Key Fixes:
- Removed invalid kernel/module parameters for iwlwifi and asus_wmi
- Added proper kernel parameters for Intel WiFi and ACPI compatibility
- Created robust systemd services for WiFi initialization
- Dynamic WiFi device detection and management

## Electron/VS Code Wayland Warnings Resolution

### Issues Resolved:
- **Electron Flag Warnings**: Eliminated unknown option warnings in VS Code/Electron apps
- **NIXOS_OZONE_WL Conflicts**: Resolved environment variable conflicts with custom configs
- **Wayland Compatibility**: Maintained proper Wayland functionality without warnings

### Key Fixes:
- Custom VS Code overlay with minimal, valid Wayland flags
- Disabled problematic environment variables for specific configurations  
- Replaced problematic flags with clean `--ozone-platform=wayland`
- Maintains Wayland support while eliminating all warnings

### Implementation:
```nix
# Custom VS Code configuration in laptop/configuration.nix
nixpkgs.overlays = [
  (final: prev: {
    vscode = prev.vscode.overrideAttrs (oldAttrs: {
      postFixup = (oldAttrs.postFixup or "") + ''
        rm $out/bin/code
        cat > $out/bin/code << EOF
#!${final.bash}/bin/bash
exec -a "\$0" "$out/bin/.code-wrapped" \\
  --ozone-platform=wayland \\
  "\$@"
EOF
        chmod +x $out/bin/code
      '';
    });
  })
];
```

### Results

- âœ… **No more Electron warnings**: Eliminated `ozone-platform-hint`, `enable-features`, and `enable-wayland-ime` warnings
- âœ… **Clean VS Code startup**: No error messages or unknown flag warnings
- âœ… **Maintained Wayland support**: VS Code continues to run natively on Wayland
- âœ… **Proper integration**: Full desktop environment integration preserved
