# ~/.zshrc - Interactive ZSH configuration
# This file is sourced for interactive shells

# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
    source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# Path to your Oh My Zsh installation
# Check for Nix store path first, fallback to home directory
if [[ -d "/run/current-system/sw/share/oh-my-zsh" ]]; then
    export ZSH="/run/current-system/sw/share/oh-my-zsh"
elif [[ -d "$HOME/.oh-my-zsh" ]]; then
    export ZSH="$HOME/.oh-my-zsh"
else
    echo "Warning: Oh My Zsh not found in expected locations"
    export ZSH="$HOME/.oh-my-zsh"  # Default fallback
fi

# Oh My Zsh Theme Configuration
# Note: Using Nix-installed Powerlevel10k, not oh-my-zsh theme system
ZSH_THEME=""

# Oh My Zsh Configuration
CASE_SENSITIVE="false"
HYPHEN_INSENSITIVE="true"
DISABLE_AUTO_UPDATE="true"  # Nix manages updates
DISABLE_MAGIC_FUNCTIONS="false"
DISABLE_LS_COLORS="false"
DISABLE_AUTO_TITLE="false"
ENABLE_CORRECTION="false"
COMPLETION_WAITING_DOTS="true"
DISABLE_UNTRACKED_FILES_DIRTY="false"
HIST_STAMPS="yyyy-mm-dd"

# Oh My Zsh plugins
plugins=(
    git
    colored-man-pages
    command-not-found
    sudo
    history-substring-search
)

# Load Oh My Zsh
source $ZSH/oh-my-zsh.sh

# Load Nix-installed zsh plugins (must be loaded AFTER oh-my-zsh)

# Load zsh-autosuggestions from Nix
if [[ -f "/run/current-system/sw/share/zsh-autosuggestions/zsh-autosuggestions.zsh" ]]; then
    source /run/current-system/sw/share/zsh-autosuggestions/zsh-autosuggestions.zsh
fi

# Load zsh-you-should-use from Nix (for alias suggestions)
if [[ -f "/run/current-system/sw/share/zsh/site-functions/you-should-use.plugin.zsh" ]]; then
    source /run/current-system/sw/share/zsh/site-functions/you-should-use.plugin.zsh
fi

# Load zsh-fast-syntax-highlighting from Nix (must be loaded before zsh-syntax-highlighting)
if [[ -f "/run/current-system/sw/share/zsh/site-functions/fast-syntax-highlighting.plugin.zsh" ]]; then
    source /run/current-system/sw/share/zsh/site-functions/fast-syntax-highlighting.plugin.zsh
fi

# Load zsh-syntax-highlighting from Nix (must be loaded last among syntax highlighters)
if [[ -f "/run/current-system/sw/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh" ]]; then
    source /run/current-system/sw/share/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh
fi

# Catppuccin Mocha Theme for zsh-syntax-highlighting
# Must be loaded AFTER zsh-syntax-highlighting
ZSH_HIGHLIGHT_HIGHLIGHTERS=(main cursor)
typeset -gA ZSH_HIGHLIGHT_STYLES

# Functions/methods
ZSH_HIGHLIGHT_STYLES[alias]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[suffix-alias]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[global-alias]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[function]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[command]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[precommand]='fg=#a6e3a1,italic'
ZSH_HIGHLIGHT_STYLES[autodirectory]='fg=#fab387,italic'
ZSH_HIGHLIGHT_STYLES[single-hyphen-option]='fg=#fab387'
ZSH_HIGHLIGHT_STYLES[double-hyphen-option]='fg=#fab387'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument]='fg=#cba6f7'

# Built-ins
ZSH_HIGHLIGHT_STYLES[builtin]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[reserved-word]='fg=#a6e3a1'
ZSH_HIGHLIGHT_STYLES[hashed-command]='fg=#a6e3a1'

# Punctuation
ZSH_HIGHLIGHT_STYLES[commandseparator]='fg=#f38ba8'
ZSH_HIGHLIGHT_STYLES[command-substitution-delimiter]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[command-substitution-delimiter-unquoted]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[process-substitution-delimiter]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument-delimiter]='fg=#f38ba8'
ZSH_HIGHLIGHT_STYLES[back-double-quoted-argument]='fg=#f38ba8'
ZSH_HIGHLIGHT_STYLES[back-dollar-quoted-argument]='fg=#f38ba8'

# Strings
ZSH_HIGHLIGHT_STYLES[command-substitution-quoted]='fg=#f9e2af'
ZSH_HIGHLIGHT_STYLES[command-substitution-delimiter-quoted]='fg=#f9e2af'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument]='fg=#f9e2af'
ZSH_HIGHLIGHT_STYLES[single-quoted-argument-unclosed]='fg=#eba0ac'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument]='fg=#f9e2af'
ZSH_HIGHLIGHT_STYLES[double-quoted-argument-unclosed]='fg=#eba0ac'
ZSH_HIGHLIGHT_STYLES[rc-quote]='fg=#f9e2af'

# Variables
ZSH_HIGHLIGHT_STYLES[dollar-quoted-argument]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[dollar-quoted-argument-unclosed]='fg=#eba0ac'
ZSH_HIGHLIGHT_STYLES[dollar-double-quoted-argument]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[assign]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[named-fd]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[numeric-fd]='fg=#cdd6f4'

# Other
ZSH_HIGHLIGHT_STYLES[unknown-token]='fg=#eba0ac'
ZSH_HIGHLIGHT_STYLES[path]='fg=#cdd6f4,underline'
ZSH_HIGHLIGHT_STYLES[path_pathseparator]='fg=#f38ba8,underline'
ZSH_HIGHLIGHT_STYLES[path_prefix]='fg=#cdd6f4,underline'
ZSH_HIGHLIGHT_STYLES[path_prefix_pathseparator]='fg=#f38ba8,underline'
ZSH_HIGHLIGHT_STYLES[globbing]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES['history-expansion']='fg=#cba6f7'
ZSH_HIGHLIGHT_STYLES[back-quoted-argument-unclosed]='fg=#eba0ac'
ZSH_HIGHLIGHT_STYLES[redirection]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[arg0]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[default]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[cursor]='fg=#cdd6f4'
ZSH_HIGHLIGHT_STYLES[comment]='fg=#585b70'

# Configure zsh-autosuggestions
ZSH_AUTOSUGGEST_HIGHLIGHT_STYLE="fg=#6c7086,bold"
ZSH_AUTOSUGGEST_STRATEGY=(history completion)
ZSH_AUTOSUGGEST_BUFFER_MAX_SIZE=20

# Initialize zoxide (better cd alternative)
if command -v zoxide &>/dev/null; then
    eval "$(zoxide init zsh)"
fi

# History configuration
HISTSIZE=10000
SAVEHIST=10000
HISTFILE="$HOME/.zsh_history"
setopt hist_ignore_dups
setopt hist_ignore_space
setopt hist_verify
setopt share_history

# ZSH options for better user experience
setopt auto_cd
setopt auto_pushd
setopt pushd_ignore_dups
setopt correct
setopt complete_in_word
setopt always_to_end

# Key bindings
bindkey '^[[A' history-substring-search-up
bindkey '^[[B' history-substring-search-down
bindkey '^P' history-substring-search-up
bindkey '^N' history-substring-search-down

# Aliases
# Basic ls improvements
alias ll='eza -la --group-directories-first'
alias la='eza -a --group-directories-first'
alias l='eza -l --group-directories-first'
alias ls='eza --group-directories-first'
alias tree='eza --tree'

# Navigation
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias .....='cd ../../../..'

# Colorize grep output
alias grep='grep --color=auto'
alias fgrep='fgrep --color=auto'
alias egrep='egrep --color=auto'

# Safe file operations
alias cp='cp -i'
alias mv='mv -i'
alias rm='rm -i'

# Git shortcuts
alias gs='git status'
alias ga='git add'
alias gc='git commit'
alias gp='git push'
alias gl='git log --oneline'
alias gd='git diff'
alias gb='git branch'
alias gco='git checkout'
alias gcb='git checkout -b'

# Modern replacements
alias cat='bat'
alias find='fd'
alias du='dust'
alias df='duf'
alias ps='procs'
alias top='btop'

# Development tools
alias vim='nvim'
alias vi='nvim'

# Kitty terminal specific aliases
if [[ "$TERM" == "xterm-kitty" ]]; then
    alias ssh='kitty +kitten ssh'
    alias icat='kitty +kitten icat'
    alias d='kitty +kitten diff'
fi

# User script aliases
alias nixswitch="$HOME/NixOS/user-scripts/nixswitch"
alias nix-shell-selector="$HOME/NixOS/user-scripts/nix-shell-selector.sh"
alias textractor="$HOME/NixOS/user-scripts/textractor.sh"

# Chezmoi aliases for dotfiles management
alias dotfiles-apply='chezmoi apply --source ~/NixOS/dotfiles'
alias dotfiles-status='chezmoi status --source ~/NixOS/dotfiles'
alias dotfiles-edit='chezmoi edit --source ~/NixOS/dotfiles'
alias dotfiles-add='chezmoi add --source ~/NixOS/dotfiles'
alias dotfiles-sync='chezmoi git pull -- --rebase && chezmoi apply --source ~/NixOS/dotfiles'
alias dotfiles='dotfiles-status'
alias cm='dotfiles-apply'

# Music streaming aliases
alias spotify-gui='spot'
alias spotify-tui='ncspot'

# Editor aliases
alias zed='zeditor'
alias code='code --enable-features=UseOzonePlatform --ozone-platform=wayland'

# X11 session specific environment variables (for compatibility)
if [[ "$XDG_SESSION_TYPE" == "x11" ]]; then
    export KITTY_DISABLE_WAYLAND=1
    export DISPLAY="${DISPLAY:-:0}"
fi

# Load Powerlevel10k theme (must be at the end)
if [[ -f "/run/current-system/sw/share/zsh-powerlevel10k/powerlevel10k.zsh-theme" ]]; then
    source /run/current-system/sw/share/zsh-powerlevel10k/powerlevel10k.zsh-theme
elif [[ -f "$HOME/powerlevel10k/powerlevel10k.zsh-theme" ]]; then
    source "$HOME/powerlevel10k/powerlevel10k.zsh-theme"
else
    echo "Warning: Powerlevel10k theme not found in expected locations"
fi

# Load p10k configuration (must be at the very end)
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh