#!/usr/bin/env bash
# branch-check - Verify git branch status for AI agents
#
# This script should be run:
#   1. At the start of every AI session
#   2. Before committing changes
#   3. Before ending a session
#
# Exit codes:
#   0 - On a host branch (good)
#   1 - On a feature branch (needs attention)
#   2 - Not in a git repository

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if in git repo
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    echo -e "${RED}ERROR: Not in a git repository${NC}"
    exit 2
fi

CURRENT_BRANCH=$(git branch --show-current)
REPO_ROOT=$(git rev-parse --show-toplevel)

echo "=================================="
echo "  Git Branch Status Check"
echo "=================================="
echo ""
echo "Repository: $REPO_ROOT"
echo "Current branch: $CURRENT_BRANCH"
echo ""

# Check if on a host branch
if [[ "$CURRENT_BRANCH" =~ ^host/ ]]; then
    echo -e "${GREEN}✓ ON HOST BRANCH - Good!${NC}"
    echo ""
    echo "You are on a host branch. Safe to:"
    echo "  - Make small changes directly"
    echo "  - Create feature branches for larger work"
    echo ""
    
    # Show any uncommitted changes
    if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
        echo -e "${YELLOW}⚠ Uncommitted changes detected:${NC}"
        git status --short
        echo ""
    fi
    
    # Show commits ahead of remote
    REMOTE_BRANCH="origin/$CURRENT_BRANCH"
    if git rev-parse --verify "$REMOTE_BRANCH" > /dev/null 2>&1; then
        AHEAD=$(git rev-list --count "$REMOTE_BRANCH..$CURRENT_BRANCH" 2>/dev/null || echo "0")
        if [[ "$AHEAD" -gt 0 ]]; then
            echo -e "${YELLOW}⚠ $AHEAD commit(s) ahead of remote${NC}"
            echo "Consider pushing: git push origin $CURRENT_BRANCH"
            echo ""
        fi
    fi
    
    exit 0

elif [[ "$CURRENT_BRANCH" == "main" ]] || [[ "$CURRENT_BRANCH" == "master" ]]; then
    echo -e "${YELLOW}⚠ ON MAIN BRANCH${NC}"
    echo ""
    echo "You are on the main branch. This is usually for:"
    echo "  - Production-ready releases only"
    echo "  - Merging from host branches"
    echo ""
    echo "For development work, switch to a host branch:"
    echo "  git checkout host/desktop"
    echo ""
    exit 0

else
    # On a feature branch
    echo -e "${RED}⚠ ON FEATURE BRANCH - Action Required!${NC}"
    echo ""
    echo "AI agents should NOT stay on feature branches indefinitely."
    echo ""
    
    # Find the likely target branch
    TARGET_BRANCH="host/desktop"
    if git rev-parse --verify "host/desktop" > /dev/null 2>&1; then
        TARGET_BRANCH="host/desktop"
    elif git rev-parse --verify "host/laptop" > /dev/null 2>&1; then
        TARGET_BRANCH="host/laptop"
    elif git rev-parse --verify "main" > /dev/null 2>&1; then
        TARGET_BRANCH="main"
    fi
    
    # Count commits ahead
    COMMITS_AHEAD=$(git rev-list --count "$TARGET_BRANCH..$CURRENT_BRANCH" 2>/dev/null || echo "?")
    echo "Commits ahead of $TARGET_BRANCH: $COMMITS_AHEAD"
    echo ""
    
    # Show what needs to be done
    echo "Before ending this session, you MUST either:"
    echo ""
    echo "  Option 1: Merge completed work"
    echo "  ─────────────────────────────"
    echo "  # Verify build passes"
    echo "  nix build .#nixosConfigurations.desktop.config.system.build.toplevel --dry-run"
    echo ""
    echo "  # Merge to host branch"
    echo "  git checkout $TARGET_BRANCH"
    echo "  git merge $CURRENT_BRANCH"
    echo ""
    echo "  # Delete feature branch"
    echo "  git branch -d $CURRENT_BRANCH"
    echo ""
    echo "  Option 2: Document incomplete work"
    echo "  ───────────────────────────────────"
    echo "  # Update handoff.md with remaining tasks"
    echo "  # Push branch to remote for continuity"
    echo "  git push -u origin $CURRENT_BRANCH"
    echo ""
    
    # Show uncommitted changes
    if ! git diff --quiet 2>/dev/null || ! git diff --cached --quiet 2>/dev/null; then
        echo -e "${YELLOW}Uncommitted changes:${NC}"
        git status --short
        echo ""
    fi
    
    exit 1
fi
