# Data Model: Flake-Parts Integration Entities

**Date**: 2025-11-24
**Feature**: 001-flake-parts-integration
**Purpose**: Define entities, their attributes, and relationships in the flake-parts migration

---

## Entity Relationship Diagram

```
┌─────────────────────────────┐
│      flake.nix (Entry)      │
│                             │
│  - systems: [string]        │
│  - imports: [path]          │
└──────────────┬──────────────┘
               │
               │ imports
               │
       ┌───────┴───────┐
       │               │
       ▼               ▼
┌─────────────┐ ┌─────────────┐
│  hosts.nix  │ │ outputs.nix │
│ (Module)    │ │  (Module)   │
└──────┬──────┘ └──────┬──────┘
       │               │
       │ exports       │ exports
       │               │
       ▼               ▼
┌───────────────────────────────┐
│ flake.nixosConfigurations     │
│ - desktop: NixOSConfig        │
│ - laptop: NixOSConfig         │
│ - nixos: alias                │
│ - nixos-desktop: alias        │
│ - nixos-laptop: alias         │
│ - default: alias              │
└────────────┬──────────────────┘
             │
             │ generated by
             │
             ▼
      ┌───────────────┐
      │ mkNixosSystem │
      │  (Function)   │
      └───────┬───────┘
              │
              │ uses
              │
              ▼
       ┌────────────┐
       │ withSystem │
       │  (Helper)  │
       └──────┬─────┘
              │
              │ provides access to
              │
              ▼
┌──────────────────────────────┐
│      perSystem Context       │
│ - pkgs: Nixpkgs              │
│ - config: ModuleConfig       │
│ - self': SelfOutputs         │
│ - inputs': InputOutputs      │
│ - system: string             │
└──────────────────────────────┘

┌──────────────────────────────┐
│   perSystem Outputs          │
│ - checks: {name: derivation} │
│ - formatter: derivation      │
│ - devShells: {name: shell}   │
│ - apps: {name: app}          │
│ - packages: {name: pkg}      │
└──────────────────────────────┘
```

---

## Entity Definitions

### 1. Flake-Parts Module

**Description**: A modular unit of flake configuration that defines outputs using flake-parts conventions.

**Attributes**:
- `imports`: Array of paths to other flake-parts modules
- `perSystem`: Function receiving per-system context, returns per-system outputs
- `flake`: Attrset of flake-level outputs (escape hatch for non-migrated outputs)
- `systems`: Array of supported system strings (e.g., `["x86_64-linux"]`)

**Relationships**:
- Imported by: flake.nix (root entry point)
- Imports: Other flake-parts modules
- Defines: perSystem outputs, flake outputs

**Validation Rules**:
- Must be a valid Nix function or attrset
- `perSystem` must be a function if present
- `flake` must be an attrset if present
- Outputs must conform to flake schema

**States**:
- Draft: Being developed, not yet integrated
- Integrated: Imported in flake.nix, active
- Deprecated: Marked for removal, still present

---

### 2. Host Definition

**Description**: Data structure describing a NixOS system's configuration parameters.

**Attributes**:
- `system`: String (e.g., "x86_64-linux", "aarch64-linux") - target architecture
- `hostname`: String - network hostname for the system
- `configPath`: String - relative path to host config dir (e.g., "desktop", "laptop")
- `nixpkgsInput`: Flake input - which nixpkgs to use (defaults to `inputs.nixpkgs`)
- `extraModules`: Array of NixOS modules - additional modules to include
- `extraSpecialArgs`: Attrset - additional arguments to pass to modules

**Relationships**:
- Defined in: `flake-modules/hosts.nix`
- Consumed by: `mkNixosSystem` function
- Produces: NixOS Configuration (via `mkNixosSystem`)
- References: Host configuration file (`hosts/${configPath}/configuration.nix`)

**Validation Rules**:
- `system` must be in declared `systems` array
- `hostname` must be valid DNS hostname
- `configPath` must point to existing directory with `configuration.nix`
- `nixpkgsInput` must be a valid flake input with `lib.nixosSystem`

**Invariants**:
- Each host must have unique `hostname`
- Each host must have unique `configPath`
- `nixpkgsInput` must provide `lib.nixosSystem` function

---

### 3. Per-System Output

**Description**: System-architecture-specific flake outputs (checks, devShells, formatter, apps, packages).

**Attributes**:
- `checks`: Attrset of derivations (name → derivation) - tests and validations
- `formatter`: Derivation - code formatter executable
- `devShells`: Attrset of shells (name → mkShell derivation) - development environments
- `apps`: Attrset of apps (name → {type, program}) - runnable programs
- `packages`: Attrset of packages (name → derivation) - buildable packages

**Relationships**:
- Defined in: `flake-modules/outputs.nix` via `perSystem`
- Accessed by: Host configurations via `withSystem`
- Exposed as: `self.checks.${system}`, `self.devShells.${system}`, etc.
- Referenced by: `self'.checks.foo` (system-specific shorthand)

**Validation Rules**:
- Checks must be derivations that exit 0 on success
- Formatter must be executable derivation
- DevShells must be mkShell derivations
- Apps must have `type = "app"` and `program` path
- Packages must be valid derivations

**States**:
- Building: Derivation is being built
- Built: Derivation is in /nix/store
- Failed: Build failed with error

---

### 4. NixOS Configuration

**Description**: Complete NixOS system configuration generated by `mkNixosSystem`, consumed by `nixos-rebuild`.

**Attributes**:
- `config`: Attrset - final evaluated NixOS configuration
- `options`: Attrset - all available NixOS options
- `pkgs`: Nixpkgs - package set for this system
- `system`: String - target architecture
- `extendModules`: Function - extend configuration with more modules
- `type`: "nixos" - configuration type identifier

**Relationships**:
- Generated by: `mkNixosSystem` function
- Exposed as: `flake.nixosConfigurations.${name}`
- Imports: Host configuration file, NixOS modules from `modules/`
- Built by: `nixos-rebuild` command
- References: Hardware configuration, role modules, package modules

**Validation Rules**:
- Must be valid NixOS configuration (evaluates without errors)
- Must have defined `system.stateVersion`
- Must have defined `networking.hostName`
- Must include hardware-configuration.nix
- Must build successfully with `nixos-rebuild build`

**Lifecycle**:
1. Define host in `hosts = { ... }`
2. Generate via `mkNixosSystem`
3. Expose via `flake.nixosConfigurations`
4. Build with `nixos-rebuild build --flake .#hostname`
5. Deploy with `nixos-rebuild switch --flake .#hostname`

---

### 5. mkNixosSystem Function

**Description**: Helper function that creates NixOS configurations with access to perSystem context.

**Signature**:
```nix
mkNixosSystem :: {
  system :: String,
  hostname :: String,
  configPath :: String,
  nixpkgsInput :: FlakeInput,
  extraModules :: [Module],
  extraSpecialArgs :: Attrset
} -> NixOSConfiguration
```

**Behavior**:
1. Accepts Host Definition attributes
2. Calls `withSystem` to access perSystem context
3. Computes `systemVersion` from nixpkgsInput
4. Creates package sets (pkgs, pkgs-unstable)
5. Assembles `specialArgs` with inputs, self', inputs', etc.
6. Calls `nixpkgsInput.lib.nixosSystem` with configuration
7. Returns NixOS Configuration

**Relationships**:
- Defined in: `flake-modules/hosts.nix`
- Called by: `nixpkgs.lib.mapAttrs` over `hosts` attrset
- Uses: `withSystem` from flake-parts
- Calls: `nixpkgsInput.lib.nixosSystem`
- Returns: NixOS Configuration

**Validation**:
- Input must match Host Definition schema
- Output must be valid NixOS Configuration
- Must maintain backward compatibility with existing host configs

---

### 6. Shared Config Module

**Description**: Reusable flake-level configuration that can be imported in flake.nix.

**Attributes**:
- `imports`: Array of paths - other modules to import
- `perSystem`: Function - per-system output definitions
- `flake`: Attrset - flake-level outputs
- `options`: Attrset - module-specific options

**Relationships**:
- Defined in: `flake-modules/*.nix`
- Imported by: flake.nix `imports = [ ... ]`
- Can import: Other flake-parts modules
- Exposes: Outputs merged into final flake

**Types**:
- Host module (`hosts.nix`): Defines `flake.nixosConfigurations`
- Output module (`outputs.nix`): Defines `perSystem` outputs
- Overlay module: Defines `flake.overlays`
- Module export: Defines `flake.nixosModules`

**Validation Rules**:
- Must be valid flake-parts module
- Must not cause infinite recursion
- Outputs must not conflict with other modules
- Must be pure (no side effects)

---

## State Transitions

### Migration State Machine

```
[Monolithic flake.nix]
         │
         │ Wrap in mkFlake
         ▼
[Setup: flake = { ... } escape hatch]
         │
         │ Create flake-modules/outputs.nix
         │ Migrate perSystem outputs
         ▼
[Hybrid: perSystem + flake escape hatch]
         │
         │ Create flake-modules/hosts.nix
         │ Migrate nixosConfigurations
         ▼
[Complete: Remove escape hatch]
         │
         │ Test & validate
         ▼
[Migrated: Full flake-parts structure]
```

### Host Configuration State

```
[Defined in hosts = { ... }]
         │
         │ mkNixosSystem
         ▼
[Generated NixOS Configuration]
         │
         │ nixos-rebuild build
         ▼
[Built in /nix/store]
         │
         │ nixos-rebuild switch
         ▼
[Active on system]
```

---

## Data Flow

1. **flake.nix** loads → imports `flake-modules/*.nix`
2. **hosts.nix** defines → `hosts = { desktop = {...}, laptop = {...} }`
3. **mkNixosSystem** maps over hosts → generates NixOS Configurations
4. **withSystem** provides → perSystem context to each host
5. **outputs.nix** defines → perSystem checks, devShells, formatter, apps, packages
6. **Host configs** receive → specialArgs (inputs, self', inputs', pkgs-unstable, etc.)
7. **Final flake** exposes → all outputs for consumption by nix commands

---

## Invariants

1. **System Consistency**: All per-system outputs must support declared systems
2. **Host Uniqueness**: No two hosts can have same hostname or configPath
3. **Build Validity**: All nixosConfigurations must build without errors
4. **Backward Compatibility**: All existing build commands must continue to work
5. **Module Purity**: All flake-parts modules must be pure (no side effects)
6. **Output Completeness**: All required outputs (nixosConfigurations, formatter, checks) must be defined
7. **Alias Correctness**: Compatibility aliases must reference actual host configs
8. **Import Validity**: All imports must point to existing, valid flake-parts modules

---

## Constraints

1. **Performance**: Flake evaluation time must remain within 5% of current baseline
2. **Compatibility**: Must work with NixOS 25.11+ and flake-parts latest stable
3. **Directory Structure**: Must preserve existing `hosts/`, `modules/` directories
4. **Constitutional**: Must comply with all 5 constitution principles
5. **Testing**: Must pass all existing checks (format-check, lint-check, eval-test)
6. **Documentation**: All entities must be documented in CLAUDE.md after migration
